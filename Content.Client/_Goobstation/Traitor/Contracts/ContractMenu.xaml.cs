using System.Linq;
using Content.Client.Message;
using Content.Shared._Goobstation.Traitor.Contracts;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.CustomControls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client._Goobstation.Traitor.Contracts;

[GenerateTypedNameReferences]
public sealed partial class ContractMenu : DefaultWindow
{
    [Dependency] private readonly IPrototypeManager _proto = default!;

    public event Action<ProtoId<ContractPrototype>>? OnContractAccept;
    public event Action<int>? OnContractAbandon;
    public event Action<int>? OnContractClaimReward;

    private ContractMenuTab _currentTab = ContractMenuTab.Available;
    private ContractMenuState? _lastState;

    public ContractMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        var group = new ButtonGroup();
        AvailableTabButton.Group = group;
        ActiveTabButton.Group = group;
        CompletedTabButton.Group = group;

        AvailableTabButton.OnPressed += _ => SetTab(ContractMenuTab.Available);
        ActiveTabButton.OnPressed += _ => SetTab(ContractMenuTab.Active);
        CompletedTabButton.OnPressed += _ => SetTab(ContractMenuTab.Completed);
    }

    public void UpdateState(ContractMenuState state)
    {
        _lastState = state;

        StatsLabel.SetMarkup(Loc.GetString("contract-menu-total-earned", ("amount", state.TotalEarned)));
        ActiveCountLabel.SetMarkup(Loc.GetString("contract-menu-active-count",
            ("current", state.ActiveContracts.Count),
            ("max", state.MaxActiveContracts)));

        AvailableTabButton.Text = Loc.GetString("contract-menu-tab-available") + $" ({state.AvailableContracts.Count})";
        ActiveTabButton.Text = Loc.GetString("contract-menu-tab-active") + $" ({state.ActiveContracts.Count})";
        CompletedTabButton.Text = Loc.GetString("contract-menu-tab-completed") + $" ({state.CompletedContracts.Count})";

        RefreshList();
    }

    private void SetTab(ContractMenuTab tab)
    {
        _currentTab = tab;
        RefreshList();
    }

    private void RefreshList()
    {
        ContractListContainer.RemoveAllChildren();

        if (_lastState == null)
            return;

        var contracts = _currentTab switch
        {
            ContractMenuTab.Available => _lastState.AvailableContracts,
            ContractMenuTab.Active => _lastState.ActiveContracts,
            ContractMenuTab.Completed => _lastState.CompletedContracts,
            _ => new List<ContractData>()
        };

        if (contracts.Count == 0)
        {
            var emptyLabel = new Label
            {
                Text = Loc.GetString(_currentTab switch
                {
                    ContractMenuTab.Available => "contract-menu-no-available",
                    ContractMenuTab.Active => "contract-menu-no-active",
                    ContractMenuTab.Completed => "contract-menu-no-completed",
                    _ => "contract-menu-no-contracts"
                }),
                HorizontalAlignment = HAlignment.Center,
                Margin = new Thickness(0, 20, 0, 0)
            };
            ContractListContainer.AddChild(emptyLabel);
            return;
        }

        foreach (var contract in contracts.OrderByDescending(c => c.Reward))
        {
            var entry = CreateContractEntry(contract);
            ContractListContainer.AddChild(entry);
        }
    }

    private Control CreateContractEntry(ContractData contract)
    {
        var panel = new PanelContainer
        {
            Margin = new Thickness(0, 0, 0, 5)
        };

        var box = new BoxContainer
        {
            Orientation = BoxContainer.LayoutOrientation.Vertical,
            Margin = new Thickness(10, 8, 10, 8)
        };

        var headerBox = new BoxContainer
        {
            Orientation = BoxContainer.LayoutOrientation.Horizontal
        };

        var titleLabel = new RichTextLabel
        {
            HorizontalExpand = true
        };
        titleLabel.SetMarkup($"[bold]{contract.Title}[/bold]");

        var rewardLabel = new Label
        {
            Text = Loc.GetString("contract-menu-reward", ("amount", contract.Reward)),
            StyleClasses = { "LabelKeyText" }
        };

        if (_proto.TryIndex(contract.PrototypeId, out var proto))
        {
            var difficulty = new string('★', proto.Difficulty) + new string('☆', 5 - proto.Difficulty);
            rewardLabel.Text = $"{difficulty} | {rewardLabel.Text}";
        }

        headerBox.AddChild(titleLabel);
        headerBox.AddChild(rewardLabel);

        var descLabel = new RichTextLabel
        {
            Margin = new Thickness(0, 5, 0, 5)
        };
        descLabel.SetMarkup(contract.Description);

        box.AddChild(headerBox);
        box.AddChild(descLabel);

        if (contract.Status == ContractStatus.Active || contract.Status == ContractStatus.Completed)
        {
            var progressBox = new BoxContainer
            {
                Orientation = BoxContainer.LayoutOrientation.Horizontal,
                Margin = new Thickness(0, 5, 0, 0)
            };

            var progressBar = new ProgressBar
            {
                MinValue = 0,
                MaxValue = 1,
                Value = contract.Progress,
                HorizontalExpand = true,
                MinHeight = 20
            };

            var progressLabel = new Label
            {
                Text = $"{(int)(contract.Progress * 100)}%",
                MinWidth = 50,
                Margin = new Thickness(10, 0, 0, 0),
                HorizontalAlignment = HAlignment.Right
            };

            progressBox.AddChild(progressBar);
            progressBox.AddChild(progressLabel);
            box.AddChild(progressBox);
        }

        var buttonBox = new BoxContainer
        {
            Orientation = BoxContainer.LayoutOrientation.Horizontal,
            HorizontalAlignment = HAlignment.Right,
            Margin = new Thickness(0, 5, 0, 0)
        };

        switch (contract.Status)
        {
            case ContractStatus.Available:
                var acceptButton = new Button
                {
                    Text = Loc.GetString("contract-menu-accept")
                };
                acceptButton.OnPressed += _ => OnContractAccept?.Invoke(contract.PrototypeId);
                buttonBox.AddChild(acceptButton);
                break;

            case ContractStatus.Active:
                var abandonButton = new Button
                {
                    Text = Loc.GetString("contract-menu-abandon")
                };
                abandonButton.OnPressed += _ => OnContractAbandon?.Invoke(contract.ContractId);
                buttonBox.AddChild(abandonButton);
                break;

            case ContractStatus.Completed:
                var claimButton = new Button
                {
                    Text = Loc.GetString("contract-menu-claim", ("amount", contract.Reward))
                };
                claimButton.OnPressed += _ => OnContractClaimReward?.Invoke(contract.ContractId);

                if (_lastState?.ActiveContracts.Any(c => c.ContractId == contract.ContractId) == true)
                    buttonBox.AddChild(claimButton);
                else
                {
                    var claimedLabel = new Label
                    {
                        Text = Loc.GetString("contract-menu-claimed"),
                        StyleClasses = { "LabelSubText" }
                    };
                    buttonBox.AddChild(claimedLabel);
                }
                break;
        }

        box.AddChild(buttonBox);
        panel.AddChild(box);

        return panel;
    }

    private enum ContractMenuTab
    {
        Available,
        Active,
        Completed
    }
}
