using System.Linq;
using Content.Client.UserInterface.Controls;
using Content.Shared.Chat;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client.UserInterface.Systems.Chat;

/// <summary>
/// Window which only holds a single chatbox, useful for monitoring multiple chats simultaneously.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class ChatWindow : FancyWindow
{
    // Goobstation - AChat Popout Start
    [Dependency] private readonly IClyde _clyde = default!;
    [Dependency] private readonly IUserInterfaceManager _uiManager = default!;
    private IClydeWindow? _clydeWindow;
    private WindowRoot? _windowRoot;
    // Goobstation - AChat Popout End

    public ChatWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        // These are necessary for the controls inside the chatbox to initialize correctly:
        Chatbox.Repopulate();
        var controller = UserInterfaceManager.GetUIController<ChatUIController>();
        controller.UpdateSelectedChannel(Chatbox);

        PopOut.OnPressed += _ => Popout(); // Goobstation - AChat Popout
    }

    // Goobstation - AChat Popout Start
    private void Popout()
    {
        if (_clydeWindow != null)
            return;

        var monitor = _clyde.EnumerateMonitors().First();

        _clydeWindow = _clyde.CreateWindow(new WindowCreateParameters
        {
            Maximized = false,
            Title = "Admin Chat",
            Monitor = monitor,
            Width = 900,
            Height = 500,
        });

        _clydeWindow.RequestClosed += OnRequestClosed;
        _clydeWindow.DisposeOnClose = true;

        ChatRoot.Orphan();
        Close();

        _windowRoot = _uiManager.CreateWindowRoot(_clydeWindow);
        _windowRoot.AddChild(ChatRoot);

        PopOut.Disabled = true;
        PopOut.Visible = false;
    }

    private void OnRequestClosed(WindowRequestClosedEventArgs args)
    {
        CleanupPopout();
        Parent?.RemoveAllChildren();
    }

    private void CleanupPopout()
    {
        if (_clydeWindow == null)
            return;
        _clydeWindow.RequestClosed -= OnRequestClosed;
        _windowRoot?.Parent?.RemoveAllChildren();
        _windowRoot = null;
        _clydeWindow = null;
    }
    // Goobstation - AChat Popout End

    /// <summary>
    /// Helper method to configure this window to be useful for admins.
    /// Sets incoming filters to only admin chats and output to admin channel
    /// </summary>
    public void ConfigureForAdminChat()
    {
        Chatbox.ChatInput.ChannelSelector.Select(ChatSelectChannel.Admin);

        // Goobstation - AChat Popout
        PopOut.Disabled = false;
        PopOut.Visible = true;
        // Goobstation - AChat Popout
        var filter = Chatbox.ChatInput.FilterButton.Popup;
        foreach (var c in Enum.GetValues(typeof(ChatChannel)))
        {
            var channel = (ChatChannel)c;
            var isAdminInterest = channel == ChatChannel.Admin
                                  || channel == ChatChannel.AdminChat
                                  || channel == ChatChannel.AdminAlert
                                  || channel == ChatChannel.AdminRelated;
            filter.SetActive(channel, isAdminInterest);
        }
    }
}
