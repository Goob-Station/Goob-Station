// SPDX-FileCopyrightText: 2022 Flipp Syder <76629141+vulppine@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Nemanja <98561806+EmoGarbage404@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 Piras314 <p1r4s@proton.me>
// SPDX-FileCopyrightText: 2024 Tayrtahn <tayrtahn@gmail.com>
// SPDX-FileCopyrightText: 2024 beck-thompson <107373427+beck-thompson@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 deltanedas <39013340+deltanedas@users.noreply.github.com>
// SPDX-FileCopyrightText: 2024 deltanedas <@deltanedas:kde.org>
// SPDX-FileCopyrightText: 2024 metalgearsloth <31366439+metalgearsloth@users.noreply.github.com>
// SPDX-FileCopyrightText: 2025 Aiden <28298836+Aidenkrz@users.noreply.github.com>
// SPDX-FileCopyrightText: 2025 GabyChangelog <agentepanela2@gmail.com>
// SPDX-FileCopyrightText: 2025 Kyoth25f <kyoth25f@gmail.com>
// SPDX-FileCopyrightText: 2025 SX-7 <sn1.test.preria.2002@gmail.com>
//
// SPDX-License-Identifier: AGPL-3.0-or-later

using System.Linq; // Goobstation
using System.Numerics; // Goobstation
using Content.Client.Stylesheets; // Goobstation
using Content.Client.UserInterface.Controls;
using Content.Shared.Speech;
using Content.Shared.StatusIcon; // Goobstation
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects; // Goobstation
using Robust.Client.UserInterface; // Goobstation
using Robust.Client.UserInterface.Controls; // Goobstation
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;

namespace Content.Client.VoiceMask;

[GenerateTypedNameReferences]
public sealed partial class VoiceMaskNameChangeWindow : FancyWindow
{
    [Dependency] private readonly IPrototypeManager _protoManager = default!; // GabyStation -> Radio icons
    [Dependency] private readonly IEntitySystemManager _entitySystem = default!; // GabyStation -> Radio icons

    private readonly SpriteSystem _spriteSystem; // GabyStation -> Radio icons

    public Action<string>? OnNameChange;
    public Action<string?>? OnVerbChange;
    public Action<ProtoId<JobIconPrototype>>? OnJobIconChanged; // GabyStation -> Radio icons

    // GabyStation -> Radio icons
    private List<ProtoId<JobIconPrototype>> _jobIcons = new();
    private ProtoId<JobIconPrototype>? _currentJobIconId = new();
    private Dictionary<ProtoId<JobIconPrototype>, Button> _jobIconButtons = new();
    private ButtonGroup? _jobIconButtonGroup = new();

    // GabyStation -> Radio icons
    private const int JobIconColumnCount = 10;

    private List<(string, string)> _verbs = new();
    private string? _verb;

    public VoiceMaskNameChangeWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this); // GabyStation -> Radio icons

        _spriteSystem = _entitySystem.GetEntitySystem<SpriteSystem>(); // GabyStation -> Radio icons

        NameSelectorSet.OnPressed += _ =>
        {
            OnNameChange?.Invoke(NameSelector.Text);
        };

        SpeechVerbSelector.OnItemSelected += args =>
        {
            OnVerbChange?.Invoke((string?) args.Button.GetItemMetadata(args.Id));
            SpeechVerbSelector.SelectId(args.Id);
        };
    }

    public void ReloadVerbs(IPrototypeManager proto)
    {
        foreach (var verb in proto.EnumeratePrototypes<SpeechVerbPrototype>())
        {
            _verbs.Add((Loc.GetString(verb.Name), verb.ID));
        }
        _verbs.Sort((a, b) => a.Item1.CompareTo(b.Item1));
    }

    // GabyStation -> Radio icons
    public void ReloadJobIcons()
    {
        var icons = _protoManager.EnumeratePrototypes<JobIconPrototype>()
            .Where(icon => icon.AllowSelection).ToList();

        icons.Sort((x, y) => string.Compare(x.LocalizedJobName, y.LocalizedJobName, StringComparison.CurrentCulture));

        _jobIcons = icons.Select(icon => (ProtoId<JobIconPrototype>) icon.ID).ToList();
    }


    public void AddVerbs()
    {
        SpeechVerbSelector.Clear();

        AddVerb(Loc.GetString("chat-speech-verb-name-none"), null);
        foreach (var (name, id) in _verbs)
        {
            AddVerb(name, id);
        }
    }

    private void AddVerb(string name, string? verb)
    {
        var id = SpeechVerbSelector.ItemCount;
        SpeechVerbSelector.AddItem(name);
        if (verb is {} metadata)
            SpeechVerbSelector.SetItemMetadata(id, metadata);

        if (verb == _verb)
            SpeechVerbSelector.SelectId(id);
    }

    // GabyStation -> Radio icons
    public void AddJobIcons()
    {
        IconGrid.DisposeAllChildren();

        for (var i = 0; i < _jobIcons.Count; i++)
        {
            var jobIcon = _protoManager.Index(_jobIcons[i]);

            var styleBase = StyleBase.ButtonOpenBoth;
            var mod = i % JobIconColumnCount;

            if (mod == 0)
                styleBase = StyleBase.ButtonOpenRight;
            else if (mod == JobIconColumnCount - 1)
                styleBase = StyleBase.ButtonOpenLeft;

            var jobIconButton = new Button
            {
                Access = AccessLevel.Public,
                StyleClasses = { styleBase },
                MaxSize = new Vector2(42, 28),
                Group = _jobIconButtonGroup,
                Pressed = jobIcon.ID == _currentJobIconId,
                ToolTip = jobIcon.LocalizedJobName
            };

            var jobIconTexture = new TextureRect
            {
                Texture = _spriteSystem.Frame0(jobIcon.Icon),
                TextureScale = new Vector2(2.5f, 2.5f),
                Stretch = TextureRect.StretchMode.KeepCentered,
            };

            _jobIconButtons.Add(jobIcon.ID, jobIconButton);

            jobIconButton.AddChild(jobIconTexture);
            jobIconButton.OnPressed += args =>
            {
                _currentJobIconId = jobIcon.ID;
                OnJobIconChanged?.Invoke(jobIcon.ID);
            };

            IconGrid.AddChild(jobIconButton);
        }
    }

    public void UpdateState(string name, string? verb)
    {
        NameSelector.Text = name;
        _verb = verb;

        for (int id = 0; id < SpeechVerbSelector.ItemCount; id++)
        {
            if (string.Equals(verb, SpeechVerbSelector.GetItemMetadata(id)))
            {
                SpeechVerbSelector.SelectId(id);
                break;
            }
        }
    }

    // GabyStation -> Radio icons
    public void SetCurrentJobIcon(ProtoId<JobIconPrototype>? jobIconProtoId)
    {
        _currentJobIconId = jobIconProtoId;

        if (jobIconProtoId is not { } protoId)
        {
            // Setting it to null deselects the pressed button.
            if (_jobIconButtonGroup?.Pressed is { } pressedButton)
                pressedButton.Pressed = false;

            return;
        }

        if (!_jobIconButtons.TryGetValue(protoId, out var button))
            return;

        // ButtonGroup will take care of making the other button unpressed.
        button.Pressed = true;
    }
}
