using Content.Client.UserInterface.Controls;
using Content.Shared._FarHorizons.Power.Generation.FissionGenerator;
using Content.Shared.Atmos;
using Content.Shared.Lock;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using System.Diagnostics.CodeAnalysis;

namespace Content.Client._FarHorizons.Power.UI;

/// <summary>
/// Client-side UI used to view a nuclear reactor.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class NuclearReactorWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entityManager = null!;
    private readonly LockSystem _lock;

    private StyleBoxFlat[,] _reactorGrid;
    private TextureRect[,] _reactorRect = new TextureRect[NuclearReactorComponent.ReactorGridWidth, NuclearReactorComponent.ReactorGridHeight];

    private double[,] _temperatureGrid = new double[NuclearReactorComponent.ReactorGridWidth, NuclearReactorComponent.ReactorGridHeight];
    private int[,] _neutronGrid = new int[NuclearReactorComponent.ReactorGridWidth, NuclearReactorComponent.ReactorGridHeight];
    private string[,] _iconGrid = new string[NuclearReactorComponent.ReactorGridWidth, NuclearReactorComponent.ReactorGridHeight];
    private string[,] _partName = new string[NuclearReactorComponent.ReactorGridWidth , NuclearReactorComponent.ReactorGridHeight];

    // You thought 2 dimensions was bad
    private double[,,] _partInfo = new double[NuclearReactorComponent.ReactorGridWidth , NuclearReactorComponent.ReactorGridHeight , 3];

    private byte _displayMode = 1<<0;

    private int _targetX = 0;
    private int _targetY = 0;

    public event Action<Vector2d>? ItemActionButtonPressed;
    public event Action? EjectButtonPressed;

    public event Action<float>? ControlRodModify;

    private EntityUid _entity;

    public NuclearReactorWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _lock = _entityManager.System<LockSystem>();

        ChangeViewButton.OnPressed += _ => OnChangeViewButtonPressed();
        XIncrement.OnPressed += _ => OnXIncrement();
        XDecrement.OnPressed += _ => OnXDecrement();
        YIncrement.OnPressed += _ => OnYIncrement();
        YDecrement.OnPressed += _ => OnYDecrement();
        ItemAction.OnPressed += _ => ItemActionButtonPressed?.Invoke(new(_targetY, _targetX));
        EjectItem.OnPressed += _ => EjectButtonPressed?.Invoke();

        ControlRodsInsertLarge.OnPressed += _ => AdjustControlRods(0.1f);
        ControlRodsInsert.OnPressed += _ => AdjustControlRods(0.01f);
        ControlRodsRemove.OnPressed += _ => AdjustControlRods(-0.01f);
        ControlRodsRemoveLarge.OnPressed += _ => AdjustControlRods(-0.1f);

        InitReactorGrid();
    }

    [MemberNotNull(nameof(_reactorGrid))]
    public void InitReactorGrid()
    {
        _reactorGrid = new StyleBoxFlat[NuclearReactorComponent.ReactorGridWidth, NuclearReactorComponent.ReactorGridHeight];
        _reactorRect = new TextureRect[NuclearReactorComponent.ReactorGridWidth, NuclearReactorComponent.ReactorGridHeight];

        for (var x = 0; x < NuclearReactorComponent.ReactorGridWidth; x++)
        {
            for (var y = 0; y < NuclearReactorComponent.ReactorGridHeight; y++)
            {
                var styleBox = new StyleBoxFlat();
                var icon = new TextureRect() { 
                    SetSize = new(32, 32), 
                    TexturePath = "/Textures/_FarHorizons/Structures/Power/Generation/FissionGenerator/reactor_part_inserted/base.png"
                };

                _reactorGrid[x,y] = styleBox;
                _reactorRect[x,y] = icon;

                var control = new PanelContainer
                {
                    Margin = new Thickness(2),
                    PanelOverride = styleBox,
                    HorizontalExpand = true,
                    VerticalExpand = true,
                };
                control.AddChild(icon);
                ReactorGrid.AddChild(control);
            }
        }
    }

    public void Update(NuclearReactorBuiState msg)
    {
        Array.Clear(_temperatureGrid);
        Array.Clear(_neutronGrid);
        Array.Clear(_iconGrid);
        Array.Clear(_partName);
        Array.Clear(_partInfo);

        var zoff = NuclearReactorComponent.ReactorGridWidth * NuclearReactorComponent.ReactorGridHeight;

        for (var x = 0; x < NuclearReactorComponent.ReactorGridWidth; x++)
        {
            for (var y = 0; y < NuclearReactorComponent.ReactorGridHeight; y++)
            {
                var loc = (x * NuclearReactorComponent.ReactorGridWidth) + y;
                _temperatureGrid[x,y] = msg.TemperatureGrid[loc];
                _neutronGrid[x,y] = msg.NeutronGrid[loc];
                _iconGrid[x,y] = msg.IconGrid[loc];
                _partName[x,y] = msg.PartName[loc];
                _partInfo[x, y, 0] = msg.PartInfo[loc];
                _partInfo[x, y, 1] = msg.PartInfo[loc + zoff];
                _partInfo[x, y, 2] = msg.PartInfo[loc + (zoff * 2)];
            }
        }

        ReactorTempValue.Text = Math.Round(msg.ReactorTemp - Atmospherics.T0C, 1).ToString() + "C";
        ReactorTempBar.Value = msg.ReactorTemp;

        ReactorRadsValue.Text = Math.Round(msg.ReactorRads, 1).ToString();
        ReactorRadsBar.Value = msg.ReactorRads;

        ReactorThermValue.Text = FormatPower(msg.ReactorTherm) + "t";
        ReactorThermBar.Value = msg.ReactorTherm;

        ControlRodsValue.Text = Math.Round(msg.ControlRodActual * 50, 1).ToString() + "%";
        ControlRodsActual.Value = msg.ControlRodActual;
        ControlRodsSet.Value = msg.ControlRodSet;

        ControlRodsButtons.Visible = !_lock.IsLocked(_entity);
        ItemAction.Visible = !_lock.IsLocked(_entity);

        ItemActionLock.Visible = _lock.IsLocked(_entity);
        ControlRodsLock.Visible = _lock.IsLocked(_entity);

        ItemName.Text = msg.ItemName ?? "empty";
    }

    public void SetEntity(EntityUid entity)
    {
        _entity = entity;

        this.SetInfoFromEntity(_entityManager, _entity);
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        //Update the grid
        for (var x = 0; x < NuclearReactorComponent.ReactorGridWidth; x++)
        {
            for (var y = 0; y < NuclearReactorComponent.ReactorGridHeight; y++)
            {
                var box = _reactorGrid[x,y];
                if (_displayMode % 2 == 1)
                {
                    box.BackgroundColor = GetColor(293.15, 1200, _temperatureGrid[x, y]);
                    ViewLabel.Text = Loc.GetString("comp-nuclear-reactor-ui-view-temp");
                }
                else if ((_displayMode >> 1) % 2 == 1)
                {
                    box.BackgroundColor = GetColor(0, 7, _neutronGrid[x, y]);
                    ViewLabel.Text = Loc.GetString("comp-nuclear-reactor-ui-view-neutron");
                }
                else if ((_displayMode >> 2) % 2 == 1)
                {
                    box.BackgroundColor = y == _targetX && x == _targetY ? Color.Yellow : Color.Gray;
                    ViewLabel.Text = Loc.GetString("comp-nuclear-reactor-ui-view-target");
                }

                if (_iconGrid[x, y] != null)
                    _reactorRect[x, y].TexturePath = "/Textures/_FarHorizons/Structures/Power/Generation/FissionGenerator/reactor_part_inserted/" + _iconGrid[x, y] + ".png";
            }
        }

        UpdateTargetInfo();
        UpdateItemAction();
    }

    private static Color GetColor(double pointA, double pointB, double value)
    {
        var mid = pointA+((pointB-pointA) / 2);
        Color result;

        if (value < pointA && pointA > 0)
            result = Color.InterpolateBetween(Color.DarkBlue, Color.FromHex("#31843E"), (float)(value / pointA));
        else if (value >= pointA && value < mid)
            result = Color.InterpolateBetween(Color.FromHex("#31843E"), Color.FromHex("#BBBB00"), (float)((value - pointA) / (mid - pointA)));
        else if (value >= mid && value < pointB)
            result = Color.InterpolateBetween(Color.FromHex("#BBBB00"), Color.FromHex("#BB3232"), (float)((value - mid) / (pointB - mid)));
        else if (value >= pointB && value < pointB * 1.4)
            result = Color.InterpolateBetween(Color.FromHex("#BB3232"), Color.FromHex("#550000"), (float)((value - pointB) / ((pointB * 1.4) - pointB)));
        else if (value >= pointB * 1.4)
            result = Color.FromHex("#550000"); // Death.
        else
            result = Color.Black;

        return result;
    }

    private void OnChangeViewButtonPressed()
    {
        // The bits go marching one by one...
        _displayMode <<= 1;
        if (_displayMode >= 1 << 3)
            _displayMode = 1 << 0;
    }

    private void UpdateTargetInfo()
    {
        if (_partName[_targetY, _targetX] != null)
        {
            TargetName.Visible = true;
            TargetName.Text = _partName[_targetY, _targetX];
        }
        else
            TargetName.Visible = false;

        if (_temperatureGrid[_targetY, _targetX] != 0)
        {
            TargetTemperatureGrid.Visible = true;
            TargetTemperature.Text = Math.Round(_temperatureGrid[_targetY, _targetX]-Atmospherics.T0C, 2).ToString()+"C";
        }
        else
            TargetTemperatureGrid.Visible = false;

        if (_partInfo[_targetY, _targetX, 0] != 0)
        {
            TargetNRadiationGrid.Visible = true;
            TargetNRadiation.Text = Math.Round(_partInfo[_targetY, _targetX, 0], 2).ToString();
        }
        else
            TargetNRadiationGrid.Visible = false;

        if (_partInfo[_targetY, _targetX, 1] != 0)
        {
            TargetRadiationGrid.Visible = true;
            TargetRadiation.Text = Math.Round(_partInfo[_targetY, _targetX, 1], 2).ToString();
        }
        else
            TargetRadiationGrid.Visible = false;

        if (_partInfo[_targetY, _targetX, 2] != 0)
        {
            TargetSpentGrid.Visible = true;
            TargetSpent.Text = Math.Round(_partInfo[_targetY, _targetX, 2], 2).ToString();
        }
        else
            TargetSpentGrid.Visible = false;
    }

    private void UpdateItemAction()
    {
        if(ItemName.Text == "empty" == (TargetName.Text == "empty"))
        {
            ItemAction.Disabled = true;
            return;
        }
        else
            ItemAction.Disabled = false;

        ItemAction.Text = TargetName.Text != "empty"
            ? Loc.GetString("comp-nuclear-reactor-ui-remove-button")
            : Loc.GetString("comp-nuclear-reactor-ui-insert-button");
    }

    #region Move Target
    private void OnXIncrement()
    {
        if (_targetX >= NuclearReactorComponent.ReactorGridWidth - 1)
        {
            XIncrement.Disabled = true;
            return;
        }

        _targetX++;
        XPos.Text = _targetX.ToString();

        XIncrement.Disabled = _targetX >= NuclearReactorComponent.ReactorGridWidth - 1;
        XDecrement.Disabled = _targetX <= 0;
    }

    private void OnXDecrement()
    {
        if (_targetX <= 0)
        {
            XDecrement.Disabled = true;
            return;
        }

        _targetX--;
        XPos.Text = _targetX.ToString();

        XIncrement.Disabled = _targetX >= NuclearReactorComponent.ReactorGridWidth - 1;
        XDecrement.Disabled = _targetX <= 0;
    }

    private void OnYIncrement()
    {
        if (_targetY >= NuclearReactorComponent.ReactorGridWidth - 1)
        {
            YIncrement.Disabled = true;
            return;
        }

        _targetY++;
        YPos.Text = _targetY.ToString();

        YIncrement.Disabled = _targetY >= NuclearReactorComponent.ReactorGridHeight - 1;
        YDecrement.Disabled = _targetY <= 0;
    }

    private void OnYDecrement()
    {
        if (_targetY <= 0)
        {
            YDecrement.Disabled = true;
            return;
        }

        _targetY--;
        YPos.Text = _targetY.ToString();

        YIncrement.Disabled = _targetY >= NuclearReactorComponent.ReactorGridHeight - 1;
        YDecrement.Disabled = _targetY <= 0;
    }
    #endregion

    public void SetItemName(string? itemName) => ItemName.Text = itemName ?? "empty";

    private static string FormatPower(float power) => Loc.GetString("comp-nuclear-reactor-ui-therm-format", ("power", power));

    private void AdjustControlRods(float amount) => ControlRodModify?.Invoke(amount);
}