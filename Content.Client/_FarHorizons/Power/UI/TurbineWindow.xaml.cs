using Content.Client.Stylesheets;
using Content.Client.UserInterface.Controls;
using Content.Shared._FarHorizons.Power.Generation.FissionGenerator;
using Content.Shared.Lock;
using Content.Shared.Rounding;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Timing;
using System.Diagnostics.CodeAnalysis;

namespace Content.Client._FarHorizons.Power.UI;

/// <summary>
/// Client-side UI used to control a turbine.
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class TurbineWindow : FancyWindow
{
    // Dependencies
    [Dependency] private readonly IEntityManager _entityManager = null!;
    private readonly LockSystem _lock;

    #region Variables
    //Colors for the RPM meter. (lit)
    private static readonly Color[] _speedColors = [
        StyleNano.DangerousRedFore,
        StyleNano.DangerousRedFore,
        StyleNano.DangerousRedFore,
        Color.FromHex("#C49438"),
        Color.FromHex("#C49438"),
        Color.FromHex("#C49438"),
        Color.FromHex("#B3BF28"),
        Color.FromHex("#B3BF28"),
        Color.FromHex("#B3BF28"),
        StyleNano.GoodGreenFore,
        Color.FromHex("#C49438"),
        StyleNano.DangerousRedFore,
    ];

    //Colors for the RPM meter. (unlit)
    private static readonly Color[] _speedColorsDim =
    [
        DimStorageColor(_speedColors[0]),
        DimStorageColor(_speedColors[1]),
        DimStorageColor(_speedColors[2]),
        DimStorageColor(_speedColors[3]),
        DimStorageColor(_speedColors[4]),
        DimStorageColor(_speedColors[5]),
        DimStorageColor(_speedColors[6]),
        DimStorageColor(_speedColors[7]),
        DimStorageColor(_speedColors[8]),
        DimStorageColor(_speedColors[9]),
        DimStorageColor(_speedColors[10]),
        DimStorageColor(_speedColors[11]),
    ];

    // Style boxes for the RPM meter.
    private StyleBoxFlat[] _speedMeter;

    private int _speedLevel;

    private EntityUid _entity;

    private bool _suppressSliderEvents;
    #endregion

    #region Events
    public event Action<float>? TurbineFlowRateChanged;
    public event Action<float>? TurbineStatorLoadChanged;
    #endregion

    public TurbineWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        _lock = _entityManager.System<LockSystem>();

        InitRPMMeter();

        // Handle flow rate
        TurbineFlowRateSlider.OnValueChanged += _ =>
        {
            if (!_suppressSliderEvents)
                TurbineFlowRateChanged?.Invoke(TurbineFlowRateSlider.Value);
        };

        // Handle stator load
        TurbineStatorLoadSlider.OnValueChanged += _ =>
        {
            if (!_suppressSliderEvents)
                TurbineStatorLoadChanged?.Invoke(TurbineStatorLoadSlider.Value);
        };
    }

    #region Graphics
    public void SetEntity(EntityUid entity)
    {
        _entity = entity;

        this.SetInfoFromEntity(_entityManager, _entity);

        EntityView.SetEntity(entity);
    }

    [MemberNotNull(nameof(_speedMeter))]
    public void InitRPMMeter()
    {
        _speedMeter = new StyleBoxFlat[_speedColors.Length];

        for (var i = _speedColors.Length - 1; i >= 0; i--)
        {
            var styleBox = new StyleBoxFlat();
            _speedMeter[i] = styleBox;

            for (var j = 0; j < RPMMeter.Columns; j++)
            {
                var control = new PanelContainer
                {
                    Margin = new Thickness(2),
                    PanelOverride = styleBox,
                    HorizontalExpand = true,
                    VerticalExpand = true,
                };
                RPMMeter.AddChild(control);
            }
        }
    }

    private static Color DimStorageColor(Color color)
    {
        var hsv = Color.ToHsv(color);
        hsv.Z /= 5;
        return Color.FromHsv(hsv);
    }

    public void Update(TurbineBuiState msg)
    {
        UpdateIndicators(msg);

        TurbineFlowRateLabel.Text = Math.Round(msg.FlowRate).ToString();
        TurbineStatorLoadLabel.Text = Math.Round(msg.StatorLoad).ToString();

        Inputs.Visible = !_lock.IsLocked(_entity);
        LockedMessage.Visible = _lock.IsLocked(_entity);

        _suppressSliderEvents = true;
        TurbineFlowRateSlider.MaxValue = msg.FlowRateMax;
        TurbineFlowRateSlider.MinValue = msg.FlowRateMin;
        TurbineFlowRateSlider.Value = msg.FlowRate;

        TurbineStatorLoadSlider.MaxValue = msg.StatorLoadMax;
        TurbineStatorLoadSlider.MinValue = msg.StatorLoadMin;
        TurbineStatorLoadSlider.Value = msg.StatorLoad;
        _suppressSliderEvents = false;

        _speedLevel = ContentHelpers.RoundToNearestLevels(msg.RPM, msg.BestRPM*1.2, _speedMeter.Length);
    }

    private void UpdateIndicators(TurbineBuiState msg)
    {
        var FilePath = "/Textures/_FarHorizons/Structures/Power/Generation/FissionGenerator/indicator_lamps/";
        // These are just if/else statements in black magic form
        TurbineOverspeed.TexturePath = msg.Overspeed ? FilePath + "redlit.png" : FilePath + "reddim.png";
        TurbineOvertemp.TexturePath = msg.Overtemp ? FilePath + "redlit.png" : FilePath + "reddim.png";
        TurbineStalling.TexturePath = msg.Stalling ? FilePath + "amberlit.png" : FilePath + "amberdim.png";
        TurbineUndertemp.TexturePath = msg.Undertemp ? FilePath + "bluelit.png" : FilePath + "bluedim.png";
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        for (var i = 0; i < _speedMeter.Length; i++)
        {
            var box = _speedMeter[i];
            if (_speedLevel > i)
            {
                // On
                box.BackgroundColor = _speedColors[i];
            }
            else
            {
                box.BackgroundColor = _speedColorsDim[i];
            }
        }
    }
    #endregion
}