using Content.Client.Humanoid;
using Content.Client.UserInterface.Controls;
using Content.Shared._CorvaxGoob.AppearanceConverter;
using Content.Shared.Dataset;
using Content.Shared.Humanoid;
using Content.Shared.Humanoid.Prototypes;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.XAML;
using Robust.Client.Utility;
using Robust.Shared.Map;
using Robust.Shared.Prototypes;
using Robust.Shared.Random;
using Robust.Shared.Timing;
using static Robust.Client.UserInterface.Controls.OptionButton;

namespace Content.Client._CorvaxGoob.AppearanceConverter;

[GenerateTypedNameReferences]
public sealed partial class AppearanceConverterWindow : FancyWindow
{
    [Dependency] private readonly IEntityManager _entityManager = default!;
    [Dependency] private readonly IGameTiming _gameTiming = default!;
    [Dependency] private readonly IPrototypeManager _prototype = default!;
    [Dependency] private readonly IRobustRandom _random = default!;
    [Dependency] private readonly IClipboardManager _clipboard = null!;

    private readonly HumanoidAppearanceSystem _humanoidAppearance;

    private TimeSpan _nextPreviewRotate = TimeSpan.Zero;
    private TimeSpan _previewRotateDelay = TimeSpan.FromSeconds(2);
    private Direction _previewDirection = Direction.South;

    private readonly ProtoId<LocalizedDatasetPrototype> _tipsLoc = "InterfacesDatasetAppearanceConverter";

    private EntityUid? _previewDummy;
    private AppearanceConverterComponent? _converter;
    private EntityUid _owner;

    public Action<string>? OnProfileSelected;

    public AppearanceConverterWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        ProfilePreview.SetEntity(_previewDummy);

        ProfilesOptionButton.OnItemSelected += args => OnProfileOptionSelected(args);
        DNATextButton.OnPressed += _ =>
        {
            if (DNATextInfo.Text is not null)
                _clipboard.SetText(DNATextInfo.Text);
        };

        _humanoidAppearance = _entityManager.System<HumanoidAppearanceSystem>();

        _previewDirection = Direction.South;
        ProfilePreview.OverrideDirection = _previewDirection;

        UpdateTooltips();
    }

    private void OnProfileOptionSelected(ItemSelectedEventArgs args)
    {
        var meta = ProfilesOptionButton.GetItemMetadata(args.Id);

        if (ProfilesOptionButton.SelectedId == args.Id)
            return;

        if (_converter is null
            || meta is null
            && meta is not string)
            return;

        _converter.SelectedProfile = (string) meta;
        ProfilesOptionButton.SelectId(args.Id);


        UpdateProfile();

        OnProfileSelected?.Invoke((string) meta);
    }

    public void SetOwner(EntityUid owner)
    {
        _owner = owner;

        if (_entityManager.TryGetComponent<AppearanceConverterComponent>(_owner, out var stealerComponent))
            _converter = stealerComponent;

        UpdateList();
        UpdateProfile();
    }

    public void UpdateState(AppearanceConverterBoundUserInterfaceState state)
    {
        if (_converter is not null
            && state is not null)
        {
            if (state.SelectedProfile is not null)
                _converter.SelectedProfile = state.SelectedProfile;

            if (state.Profiles is not null)
                _converter.ProfilesVisualData = state.Profiles;

            _converter.Transformed = state.Transformed;

            _converter.NextTransformTime = state.NextTransformTime;
        }

        UpdateList();
        UpdateProfile();
    }

    /// <summary>
    /// Выбирает и обновляет случайную подсказку.
    /// </summary>
    private void UpdateTooltips()
    {
        if (!_prototype.TryIndex<LocalizedDatasetPrototype>(_tipsLoc, out var tips))
            return;

        if (tips.Values.Count == 0)
        {
            HelpButton.Visible = false;
            return;
        }

        HelpButton.Visible = true;
        HelpButton.ToolTip = Loc.GetString("interfaces-tip", ("tip", Loc.GetString(_random.Pick(tips.Values))));
    }

    /// <summary>
    /// Обновляет визуал интерфейса на основе выбранного профиля в компоненте.
    /// </summary>
    private void UpdateProfile()
    {
        if (_converter is null)
            return;

        DeTransformButton.Disabled = !_converter.Transformed;
        TransformButton.Disabled = _converter.Transformed;

        if (_converter.SelectedProfile is null)
        {
            ProfileNotSelected.Visible = true;
            ProfileNotSelectedTextBox.Visible = true;
            TransformButton.Disabled = true;
            return;
        }

        if (_previewDummy is not null)
            _entityManager.QueueDeleteEntity(_previewDummy);

        AppearanceConverterVisualTransformProfile transformData = _converter.ProfilesVisualData[_converter.SelectedProfile];

        if (transformData.SpeciesPrototype is null)
            return;

        var speciesPrototype = _prototype.Index<SpeciesPrototype>(transformData.SpeciesPrototype.Value);

        var dummyEnt = _entityManager.SpawnEntity(speciesPrototype.DollPrototype, MapCoordinates.Nullspace);

        var targetHumanoid = _entityManager.EnsureComponent<HumanoidAppearanceComponent>(dummyEnt);

        if (transformData.SkinColor is not null)
            targetHumanoid.SkinColor = transformData.SkinColor.Value;

        if (transformData.Markings is not null)
            targetHumanoid.MarkingSet = transformData.Markings;

        if (transformData.EyesColor is not null)
            targetHumanoid.EyeColor = transformData.EyesColor.Value;

        if (transformData.Sex is not null)
        {
            targetHumanoid.Sex = transformData.Sex.Value;

            switch (transformData.Sex.Value)
            {
                case Sex.Male:
                    SexTextInfo.Text = Loc.GetString("humanoid-profile-editor-sex-male-text");
                    break;
                case Sex.Female:
                    SexTextInfo.Text = Loc.GetString("humanoid-profile-editor-sex-female-text");
                    break;
                default:
                    SexTextInfo.Text = Loc.GetString("humanoid-profile-editor-sex-unsexed-text");
                    break;
            }
        }

        _humanoidAppearance.UpdateSprite((dummyEnt, targetHumanoid, _entityManager.GetComponent<SpriteComponent>(dummyEnt)));

        ProfilePreview.SetEntity(dummyEnt);
        _previewDummy = dummyEnt;

        if (transformData.Age is not null)
            AgeTextInfo.Text = transformData.Age.Value.ToString();

        if (transformData.Name is not null)
            NameTextInfo.Text = transformData.Name;

        if (transformData.DNA is not null)
            DNATextInfo.Text = transformData.DNA;

        if (transformData.Fingerprint is not null)
            FingerprintTextInfo.Text = transformData.Fingerprint;

        SpeciesTextInfo.Text = Loc.GetString(speciesPrototype.Name);

        for (var i = 0; i < ProfilesOptionButton.ItemCount; i++)
        {
            var meta = ProfilesOptionButton.GetItemMetadata(i);

            if (meta is not null && transformData.DNA == (string) meta)
                ProfilesOptionButton.SelectId(i);
        }

        _nextPreviewRotate = _gameTiming.CurTime + _previewRotateDelay;

        ProfileInformationBox.Visible = true;
        ProfilePreview.Visible = true;
        ProfileNotSelected.Visible = false;
        ProfileNotSelectedTextBox.Visible = false;

        TransformButton.Disabled = false;
    }

    /// <summary>
    /// Обновляет список из доступных профилей.
    /// </summary>
    private void UpdateList()
    {
        if (_converter is null)
            return;

        ProfilesOptionButton.Clear();

        if (_converter.ProfilesVisualData is null || _converter.ProfilesVisualData.Count == 0)
        {
            ProfilesOptionButton.Disabled = true;
            ProfilesOptionButton.AddItem(Loc.GetString("appearance-converter-ui-option-button-empty"));
            return;
        }

        ProfilesOptionButton.Disabled = false;

        int i = 0;
        foreach (var savedDNA in _converter.ProfilesVisualData)
        {
            ProfilesOptionButton.AddItem(savedDNA.Value.Name, i);
            ProfilesOptionButton.SetItemMetadata(i, savedDNA.Key);

            i++;
        }
    }

    protected override void FrameUpdate(FrameEventArgs args)
    {
        base.FrameUpdate(args);

        if (_converter is null)
            return;

        if (_gameTiming.CurTime < _converter.NextTransformTime)
        {
            TransformButton.Text = Loc.GetString("appearance-converter-ui-transform-button-time", ("remain", (int) (_converter.NextTransformTime - _gameTiming.CurTime).TotalSeconds));
            TransformButton.Disabled = true;
        }
        else
        {
            TransformButton.Text = Loc.GetString("appearance-converter-ui-transform-button");

            if (!_converter.Transformed)
                TransformButton.Disabled = _converter.SelectedProfile is null;
        }

        if (_previewDummy is null || _gameTiming.CurTime < _nextPreviewRotate)
            return;

        _nextPreviewRotate = _gameTiming.CurTime + _previewRotateDelay;

        _previewDirection = _previewDirection.TurnCcw();
        ProfilePreview.OverrideDirection = (Direction) ((int) _previewDirection % 4 * 2); // Выравнивание в любое из 4 направлений, заместо ненужного юго-запад и т.п
    }
}
