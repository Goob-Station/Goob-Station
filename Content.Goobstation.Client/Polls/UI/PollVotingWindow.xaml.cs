using System.Linq;
using Content.Client.UserInterface.Controls;
using Content.Goobstation.Shared.Polls;
using Robust.Client.AutoGenerated;
using Robust.Client.Graphics;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Goobstation.Client.Polls.UI;

[GenerateTypedNameReferences]
public sealed partial class PollVotingWindow : FancyWindow
{
    [Dependency] private readonly PollManager _pollManager = default!;

    public PollVotingWindow()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);

        RefreshButton.OnPressed += _ => RefreshPolls();

        _pollManager.OnActivePollsUpdated += HandlePollsUpdated;
        _pollManager.OnPollUpdated += HandlePollUpdated;
        _pollManager.OnPollClosed += HandlePollClosed;
        _pollManager.OnVoteResponse += HandleVoteResponse;
        _pollManager.OnPollDetailsReceived += HandlePollDetailsReceived;

        RefreshPolls();
    }

    protected override void Dispose(bool disposing)
    {
        base.Dispose(disposing);

        if (disposing)
        {
            _pollManager.OnActivePollsUpdated -= HandlePollsUpdated;
            _pollManager.OnPollUpdated -= HandlePollUpdated;
            _pollManager.OnPollClosed -= HandlePollClosed;
            _pollManager.OnVoteResponse -= HandleVoteResponse;
            _pollManager.OnPollDetailsReceived -= HandlePollDetailsReceived;
        }
    }

    private void RefreshPolls()
    {
        StatusLabel.Text = Loc.GetString("poll-voting-window-loading");
        _pollManager.RequestActivePolls();
    }

    private void HandlePollsUpdated(List<PollData> polls)
    {
        PollsList.RemoveAllChildren();

        if (polls.Count == 0)
        {
            StatusLabel.Text = Loc.GetString("poll-voting-window-no-polls");
            return;
        }

        var now = DateTime.UtcNow;
        var activeCount = polls.Count(p => p.Active && (!p.EndTime.HasValue || p.EndTime.Value >= now));
        var closedCount = polls.Count - activeCount;

        if (closedCount > 0)
            StatusLabel.Text = $"{activeCount} active, {closedCount} closed";
        else
            StatusLabel.Text = Loc.GetString("poll-voting-window-polls-count", ("count", polls.Count));

        var sortedPolls = polls.OrderBy(p =>
        {
            var now = DateTime.UtcNow;

            if (!p.Active || p.EndTime < now)
                return 3;

            if (!p.EndTime.HasValue)
                return 2;

            return 1;
        })
        .ThenBy(p => p.EndTime ?? DateTime.MaxValue)
        .ThenBy(p => p.PollId);
        foreach (var poll in sortedPolls)
        {
            _pollManager.RequestPollDetails(poll.PollId);
            var pollControl = new PollControl(poll, _pollManager);
            PollsList.AddChild(pollControl);
        }
    }

    private void HandlePollUpdated(PollData poll)
    {
        foreach (var child in PollsList.Children)
        {
            if (child is PollControl pollControl && pollControl.PollId == poll.PollId)
            {
                var votes = _pollManager.GetPlayerVotes(poll.PollId);
                pollControl.UpdateWithNewData(poll, votes);
                pollControl.EnableVoting();
                break;
            }
        }
    }

    private void HandlePollClosed(int pollId)
    {
        foreach (var child in PollsList.Children)
        {
            if (child is PollControl pollControl && pollControl.PollId == pollId)
            {
                pollControl.MarkClosed();
                break;
            }
        }
    }

    private void HandleVoteResponse(bool success, string? error)
    {
        if (!success && error != null)
        {
            StatusLabel.Text = Loc.GetString("poll-voting-window-error", ("error", error));

            foreach (var child in PollsList.Children)
            {
                if (child is PollControl pollControl)
                    pollControl.EnableVoting();
            }
        }
    }

    private void HandlePollDetailsReceived(PollData poll, List<PollVoteData> votes)
    {
        foreach (var child in PollsList.Children)
        {
            if (child is PollControl pollControl && pollControl.PollId == poll.PollId)
            {
                pollControl.UpdateWithNewData(poll, votes);
                pollControl.EnableVoting();
                break;
            }
        }
    }
}

public sealed class PollControl : BoxContainer
{
    private readonly PollManager _pollManager;
    private PollData _poll;
    private List<PollVoteData> _playerVotes = [];
    private readonly Dictionary<int, CheckBox> _optionCheckBoxes = [];
    private readonly Dictionary<int, Button> _optionButtons = [];
    private bool _isVoting;

    public int PollId => _poll.PollId;

    public PollControl(PollData poll, PollManager pollManager)
    {
        _poll = poll;
        _pollManager = pollManager;
        _playerVotes = _pollManager.GetPlayerVotes(_poll.PollId);

        Orientation = LayoutOrientation.Vertical;
        SeparationOverride = 0;

        BuildUI();
    }

    private void BuildUI()
    {
        var panel = new PanelContainer
        {
            StyleClasses = { "AngleRect" },
            MinHeight = 120
        };

        AddChild(panel);

        var container = new BoxContainer
        {
            Orientation = LayoutOrientation.Vertical,
            Margin = new Thickness(16),
            SeparationOverride = 12
        };
        panel.AddChild(container);

        var headerBox = new BoxContainer
        {
            Orientation = LayoutOrientation.Horizontal,
            SeparationOverride = 8
        };
        container.AddChild(headerBox);

        var titleLabel = new Label
        {
            Text = _poll.Title,
            StyleClasses = { "LabelHeading" },
            HorizontalExpand = true,
            FontColorOverride = new Color(0.95f, 0.95f, 1.0f)
        };
        headerBox.AddChild(titleLabel);

        var now = DateTime.UtcNow;
        var isClosed = !_poll.Active || _poll.EndTime < now;

        var statusLabel = new Label
        {
            Text = isClosed ? "[CLOSED]" : "[ACTIVE]",
            StyleClasses = { "LabelSubText" },
            FontColorOverride = isClosed ? new Color(1.0f, 0.4f, 0.4f) : new Color(0.5f, 1.0f, 0.5f),
            Margin = new Thickness(8, 0, 0, 0)
        };
        headerBox.AddChild(statusLabel);

        var descLabel = new Label
        {
            Text = _poll.Description,
            FontColorOverride = new Color(0.85f, 0.85f, 0.9f),
            MaxWidth = 600,
            HorizontalAlignment = Control.HAlignment.Left,
            StyleClasses = { "LabelSubText" }
        };
        container.AddChild(descLabel);

        var metaBox = new BoxContainer
        {
            Orientation = LayoutOrientation.Horizontal,
            SeparationOverride = 12
        };
        container.AddChild(metaBox);

        if (_poll.CreatedByName != null)
        {
            var creatorLabel = new Label
            {
                Text = "By: " + _poll.CreatedByName,
                FontColorOverride = new Color(0.6f, 0.7f, 0.9f),
                StyleClasses = { "LabelSubText" }
            };
            metaBox.AddChild(creatorLabel);
        }

        if (_poll.EndTime.HasValue)
        {
            var timeLeft = _poll.EndTime.Value - DateTime.UtcNow;
            string timeText;
            if (timeLeft.TotalSeconds > 0)
            {
                var days = (int) timeLeft.TotalDays;
                timeText = days > 0
                    ? Loc.GetString("poll-control-ends-in-days", ("days", days))
                    : Loc.GetString("poll-control-ends-in-hours", ("hours", Math.Max(1, (int) timeLeft.TotalHours)));
            }
            else
            {
                timeText = Loc.GetString("poll-control-ended");
            }

            var timeLabel = new Label
            {
                Text = timeText,
                FontColorOverride = timeLeft.TotalSeconds > 0 ? new Color(1.0f, 0.9f, 0.3f) : new Color(0.5f, 0.5f, 0.5f),
                StyleClasses = { "LabelSubText" }
            };
            metaBox.AddChild(timeLabel);
        }

        if (_poll.AllowMultipleChoices)
        {
            var multiLabel = new Label
            {
                Text = "Multiple Choice",
                FontColorOverride = new Color(0.5f, 0.8f, 1.0f),
                StyleClasses = { "LabelSubText" }
            };
            metaBox.AddChild(multiLabel);
        }

        var separator = new BoxContainer
        {
            Orientation = LayoutOrientation.Horizontal,
            MinHeight = 2,
            Margin = new Thickness(0, 4, 0, 4)
        };
        separator.AddChild(new PanelContainer
        {
            HorizontalExpand = true,
            MinHeight = 1,
            PanelOverride = new StyleBoxFlat { BackgroundColor = Color.Gray.WithAlpha(0.3f) }
        });
        container.AddChild(separator);

        var totalVotes = _poll.Options.Sum(o => o.VoteCount);
        var optionsContainer = new BoxContainer
        {
            Orientation = LayoutOrientation.Vertical,
            SeparationOverride = 8
        };
        container.AddChild(optionsContainer);

        if (_poll.AllowMultipleChoices)
        {
            foreach (var option in _poll.Options.OrderBy(o => o.DisplayOrder))
            {
                var optionBox = CreateOptionControl(option, totalVotes, true);
                optionsContainer.AddChild(optionBox);
            }
        }
        else
        {
            var buttonGroup = new ButtonGroup();

            foreach (var option in _poll.Options.OrderBy(o => o.DisplayOrder))
            {
                var optionBox = CreateOptionControl(option, totalVotes, false, buttonGroup);
                optionsContainer.AddChild(optionBox);
            }
        }
    }

    private PanelContainer CreateOptionControl(PollOptionData option, int totalVotes, bool isMultiChoice, ButtonGroup? buttonGroup = null)
    {
        var hasVoted = _playerVotes.Any(v => v.OptionId == option.OptionId);
        var percentage = totalVotes > 0 ? (option.VoteCount * 100.0f / totalVotes) : 0;

        var optionPanel = new PanelContainer
        {
            StyleClasses = { "AngleRect" },
            MinHeight = 56,
            Modulate = hasVoted ? new Color(0.3f, 0.5f, 0.35f) : new Color(0.9f, 0.9f, 0.95f)
        };

        var optionContainer = new BoxContainer
        {
            Orientation = LayoutOrientation.Horizontal,
            Margin = new Thickness(12, 10),
            SeparationOverride = 12
        };
        optionPanel.AddChild(optionContainer);

        var now = DateTime.UtcNow;
        var isClosed = !_poll.Active || _poll.EndTime < now;

        if (!isClosed)
        {
            Control voteControl;
            if (isMultiChoice)
            {
                var checkbox = new CheckBox
                {
                    Pressed = hasVoted,
                    VerticalAlignment = Control.VAlignment.Center
                };

                var optionId = option.OptionId;
                checkbox.OnToggled += args =>
                {
                    if (_isVoting)
                        return;

                    _isVoting = true;

                    if (args.Pressed)
                    {
                        var opt = _poll.Options.FirstOrDefault(o => o.OptionId == optionId);
                        if (opt != null)
                            opt.VoteCount++;
                    }
                    else
                    {
                        var opt = _poll.Options.FirstOrDefault(o => o.OptionId == optionId);
                        if (opt?.VoteCount > 0)
                            opt.VoteCount--;
                    }

                    if (args.Pressed)
                        _pollManager.CastVote(_poll.PollId, optionId);
                    else
                        _pollManager.RemoveVote(_poll.PollId, optionId);

                    _playerVotes = _pollManager.GetPlayerVotes(_poll.PollId);
                    RebuildUIOptimistically();
                };

                _optionCheckBoxes[option.OptionId] = checkbox;
                voteControl = checkbox;
            }
            else
            {
                var button = new Button
                {
                    Text = "Vote",
                    ToggleMode = true,
                    Pressed = hasVoted,
                    Group = buttonGroup,
                    MinWidth = 60,
                    VerticalAlignment = VAlignment.Center
                };

                var optionId = option.OptionId;
                button.OnPressed += _ =>
                {
                    if (_isVoting)
                        return;

                    var alreadyVoted = _playerVotes.Any(v => v.OptionId == optionId);
                    if (alreadyVoted)
                        return;

                    _isVoting = true;

                    foreach (var prevVote in _playerVotes.ToList())
                    {
                        var opt = _poll.Options.FirstOrDefault(o => o.OptionId == prevVote.OptionId);
                        if (opt?.VoteCount > 0)
                            opt.VoteCount--;
                    }

                    var newOpt = _poll.Options.FirstOrDefault(o => o.OptionId == optionId);
                    if (newOpt != null)
                        newOpt.VoteCount++;

                    _pollManager.CastVote(_poll.PollId, optionId);

                    _playerVotes = _pollManager.GetPlayerVotes(_poll.PollId);
                    RebuildUIOptimistically();
                };

                _optionButtons[option.OptionId] = button;
                voteControl = button;
            }
            optionContainer.AddChild(voteControl);
        }

        var infoBox = new BoxContainer
        {
            Orientation = LayoutOrientation.Vertical,
            HorizontalExpand = true,
            VerticalAlignment = Control.VAlignment.Center,
            SeparationOverride = 2
        };
        optionContainer.AddChild(infoBox);

        var textBox = new BoxContainer
        {
            Orientation = LayoutOrientation.Horizontal,
            SeparationOverride = 8
        };
        infoBox.AddChild(textBox);

        var optionLabel = new Label
        {
            Text = option.OptionText,
            HorizontalExpand = true,
            FontColorOverride = hasVoted ? new Color(0.6f, 1.0f, 0.7f) : new Color(0.95f, 0.95f, 0.98f)
        };
        textBox.AddChild(optionLabel);

        var voteLabel = new Label
        {
            Text = $"{option.VoteCount} votes ({percentage:F1}%)",
            FontColorOverride = hasVoted ? new Color(0.5f, 0.9f, 0.6f) : new Color(0.6f, 0.6f, 0.7f),
            StyleClasses = { "LabelSubText" }
        };
        textBox.AddChild(voteLabel);

        var progressBar = new ProgressBar
        {
            MinValue = 0,
            MaxValue = 100,
            Value = percentage,
            MinHeight = 8
        };

        if (hasVoted)
            progressBar.Modulate = new Color(0.4f, 1.0f, 0.5f);
        else if (percentage > 0)
            progressBar.Modulate = new Color(0.5f, 0.7f, 1.0f);
        else
            progressBar.Modulate = new Color(0.4f, 0.4f, 0.5f);
        infoBox.AddChild(progressBar);

        return optionPanel;
    }

    public void UpdatePoll(PollData poll)
    {
        _poll = poll;
        RemoveAllChildren();
        _optionCheckBoxes.Clear();
        _optionButtons.Clear();
        _isVoting = false;
        BuildUI();
    }

    public void UpdateWithNewData(PollData poll, List<PollVoteData> votes)
    {
        _poll = poll;
        _playerVotes = votes;
        RemoveAllChildren();
        _optionCheckBoxes.Clear();
        _optionButtons.Clear();
        _isVoting = false;
        BuildUI();
    }

    public void MarkClosed()
    {
        _poll.Active = false;
        RemoveAllChildren();
        _optionCheckBoxes.Clear();
        _optionButtons.Clear();
        BuildUI();
        DisableAllControls();
    }

    public void EnableVoting()
    {
        _isVoting = false;
        foreach (var checkbox in _optionCheckBoxes.Values)
            checkbox.Disabled = false;

        foreach (var button in _optionButtons.Values)
            button.Disabled = false;
    }

    private void DisableAllControls()
    {
        foreach (var checkbox in _optionCheckBoxes.Values)
            checkbox.Disabled = true;

        foreach (var button in _optionButtons.Values)
            button.Disabled = true;
    }

    private void RebuildUIOptimistically()
    {
        RemoveAllChildren();
        _optionCheckBoxes.Clear();
        _optionButtons.Clear();
        BuildUI();
        DisableAllControls();
    }
}
