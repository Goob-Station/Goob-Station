using Content.Client.Message;
using Content.Client.UserInterface.Controls;
using Content.Goobstation.Shared.Books;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Goobstation.Client.Books.Ui;

/// <summary>
/// Actually it's the same as admin verification but a bit different
/// </summary>
[GenerateTypedNameReferences]
public sealed partial class BookPrinterMenu : FancyWindow
{
    [Dependency] private readonly IEntityManager _entMan = default!;
    private readonly SpriteSystem _sprite;

    public int Selected = -1;
    public bool AllowDeleting = false;
    public bool Cooldown = false;

    public BookData? SelectedBook;
    public Action? PrintBook;
    public Action? DeleteBook;

    public BookPrinterMenu()
    {
        RobustXamlLoader.Load(this);
        IoCManager.InjectDependencies(this);
        _sprite = _entMan.System<SpriteSystem>();

        PrintButton.OnPressed += args => PrintBook?.Invoke();
        DeleteButton.OnPressed += args => DeleteBook?.Invoke();

        Preview.SetEntity(_entMan.Spawn("CustomBookTemplate"));
        UpdateText();
        UpdatePreview();
    }

    public void Populate(Dictionary<int, BookData> books)
    {
        BooksContainer.RemoveAllChildren();

        foreach (var item in books)
        {
            var button = new Button()
            {
                Text = item.Value.Title,
                SetHeight = 38f,
                HorizontalExpand = true,
                Disabled = item.Value.Equals(SelectedBook)
            };

            button.OnPressed += args =>
            {
                foreach (var item in BooksContainer.Children)
                {
                    if (item is Button prevButton)
                        prevButton.Disabled = false;
                }

                button.Disabled = true;
                SelectedBook = item.Value;
                Selected = item.Key;
                UpdateText();
                UpdatePreview();
            };

            BooksContainer.AddChild(button);
        }
    }

    /// <summary>
    /// Updates selected book fields
    /// </summary>
    private void UpdateText()
    {
        PrintButton.Disabled = SelectedBook == null || Cooldown;
        DeleteButton.Visible = SelectedBook != null && AllowDeleting;

        if (SelectedBook == null)
        {
            AuthorNameLabel.SetMarkup("Author: None selected");
            GenreLabel.SetMarkup("Genre: None selected");
            TitleLabel.SetMarkup("Title: None selected");
            DescLabel.SetMarkup("Desc: None selected");
            return;
        }

        AuthorNameLabel.SetMarkup($"Author: {SelectedBook.Author}");
        GenreLabel.SetMarkup($"Genre: {SelectedBook.Genre}");
        TitleLabel.SetMarkup($"Title: {SelectedBook.Title}");
        DescLabel.SetMarkup($"Desc: {SelectedBook.Desc}");
    }

    /// <summary>
    /// Updates preview entity
    /// </summary>
    private void UpdatePreview()
    {
        if (!Preview.Entity.HasValue)
            Preview.SetEntity(_entMan.Spawn("CustomBookTemplate"));

        if (SelectedBook == null)
            return;

        var ent = Preview.Entity!.Value;

        foreach (var item in SelectedBook.Binding)
        {
            if (!_sprite.TryGetLayer(ent.Owner, item.Key, out var layer, false))
                continue;

            var path = item.Value.Path;
            var state = new RSI.StateId(item.Value.State);
            _sprite.LayerSetRsi(layer, path, state);
        }
    }
}
