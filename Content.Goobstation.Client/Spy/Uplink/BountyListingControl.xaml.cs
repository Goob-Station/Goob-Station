// SPDX-FileCopyrightText: 2025 August Eymann <august.eymann@gmail.com>
// SPDX-FileCopyrightText: 2025 GoobBot <uristmchands@proton.me>
//
// SPDX-License-Identifier: AGPL-3.0-or-later

using Content.Goobstation.Shared.Spy;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Prototypes;
using Serilog;

namespace Content.Goobstation.Client.Spy.Uplink;

[GenerateTypedNameReferences]
public sealed partial class BountyListingControl : Control
{

    [Dependency] private readonly IPrototypeManager _prototype = default!;
    [Dependency] private readonly IEntityManager _entity = default!;

    // ReSharper disable once FieldCanBeMadeReadOnly.Local
    private SpyBountyData? _data;

    public BountyListingControl(SpyBountyData data)
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);

        _data = data;

        if (!_prototype.TryIndex(_data.StealGroup, out var targetGroup)
            || _data.RewardListing.ProductEntity is not { } productProtoId
            ||  !_prototype.TryIndex(productProtoId, out var productProto))
            return;

        BountyTitle.FontColorOverride = _data.Difficulty switch
        {
            SpyBountyDifficulty.Easy => Color.FromHex("#1ABC9C"),
            SpyBountyDifficulty.Medium => Color.FromHex("#FF6347"),
            SpyBountyDifficulty.Hard => Color.FromHex("#E74C3C"),
            _ => BountyTitle.FontColorOverride,
        };

        Logger.Debug(targetGroup.StealTip); // WHY DO YOU NOT WORK?
        BountyTitle.Text = Loc.GetString("objective-condition-steal-title-alive-no-owner", ("itemName", Loc.GetString(targetGroup.Name)));
        var rewardText = _data.RewardListing.Name != null ? Loc.GetString(_data.RewardListing.Name) : productProto.Name;
        RewardLabel.Text = $" {rewardText}"; // pad it with a space
        BountyDesc.Text = Loc.GetString(targetGroup.StealTip);
        if (_data.Claimed == false)
            return;
        ClaimedOverlay.Visible = true;
    }

    public void SetTexture()
    {
        if (_data is not { } data || !_prototype.TryIndex(data.StealGroup, out var targetGroup))
            return;

        var spriteSys = _entity.EntitySysManager.GetEntitySystem<SpriteSystem>();
        var texture = spriteSys.Frame0(targetGroup.Sprite);
        BountyItemTexture.Texture = texture;
    }
}
