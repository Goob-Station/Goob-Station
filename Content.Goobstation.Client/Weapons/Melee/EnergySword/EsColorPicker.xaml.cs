using Content.Client.UserInterface.Controls;
using Content.Shared.Light;
using Content.Shared.Light.Components;
using Content.Shared.Toggleable;
using Content.Shared.Weapons.Melee.EnergySword;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Goobstation.Client.Weapons.Melee.EnergySword
{
    [GenerateTypedNameReferences]
    public sealed partial class EsColorPicker : FancyWindow
    {
        [Dependency] private readonly IEntitySystemManager _entitySystem = default!;
        [Dependency] private readonly IEntityManager _entManager = default!;
        private readonly SharedRgbLightControllerSystem _rgbSystem = default!;
        private readonly SharedAppearanceSystem _appearance = default!;

        private ColorSelectorSliders _rgbSkinColorSelector;
        private Entity<EnergySwordComponent> _uid;
        private EntityUid _owner;
        public Action<Color>? OnConfirmButtonPressed;
        public Action<bool>? OnSecretButtonPressed;
        private bool _rgbActivated;

        public EsColorPicker()
        {
            RobustXamlLoader.Load(this);
            IoCManager.InjectDependencies(this);
            _appearance = _entitySystem.GetEntitySystem<SharedAppearanceSystem>();
            _rgbSystem = _entitySystem.GetEntitySystem<SharedRgbLightControllerSystem>();

            RgbSkinColorContainer.AddChild(_rgbSkinColorSelector = new ColorSelectorSliders());
            _rgbSkinColorSelector.SelectorType = ColorSelectorSliders.ColorSelectorType.Hsv;
            _rgbSkinColorSelector.OnColorChanged += ColorValueChanged;

            ConfirmButton.OnPressed += _ =>
            {
                OnConfirmButtonPressed?.Invoke(_rgbSkinColorSelector.Color);
                OnSecretButtonPressed?.Invoke(_rgbActivated);
            };
            SecretButton.OnPressed += SecretButtonPressed;
        }

        private void SecretButtonPressed(BaseButton.ButtonEventArgs args)
        {
            _rgbActivated = !_rgbActivated;
            if (_rgbActivated)
            {
                _entManager.EnsureComponent<RgbLightControllerComponent>(_uid);
                _rgbSystem.SetCycleRate(_uid, _uid.Comp.CycleRate);
            }
            else
                _entManager.RemoveComponent<RgbLightControllerComponent>(_uid);
        }

        private void ColorValueChanged(Color newColor)
        {
            if (_entManager.TryGetComponent<AppearanceComponent>(_uid, out var appearance))
                _appearance.SetData(_uid, ToggleableLightVisuals.Color, newColor, appearance);
        }

        public void SetEntity(EntityUid entity, EntityUid owner)
        {
            if (!_entManager.TryGetComponent<EnergySwordComponent>(owner, out var energySwordOwner) ||
                !_entManager.TryGetComponent<EnergySwordComponent>(entity, out var energySword))
                return;

            if (_entManager.TryGetComponent<AppearanceComponent>(entity, out var appearance))
            {
                _appearance.SetData(entity, ToggleableLightVisuals.Enabled, true, appearance);
                _appearance.SetData(entity, ToggleableLightVisuals.Color, energySwordOwner.ActivatedColor, appearance);
            }

            _rgbSkinColorSelector.Color = energySwordOwner.ActivatedColor;

            _uid = (entity, energySword);
            _owner = owner;
            EntityView.SetEntity(entity);
        }
    }
}
