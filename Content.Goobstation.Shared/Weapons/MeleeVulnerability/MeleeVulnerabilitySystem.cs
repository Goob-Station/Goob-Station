using Content.Shared.StatusEffectNew.Components;
using Content.Shared.Weapons.Melee.Events;

namespace Content.Goobstation.Shared.Weapons.MeleeVulnerability;

public sealed class MeleeVulnerabilitySystem : EntitySystem
{
    [Dependency] private readonly Content.Shared.StatusEffectNew.StatusEffectsSystem _status = default!;

    public override void Initialize()
    {
        base.Initialize();
        SubscribeLocalEvent<StatusEffectContainerComponent, AttackedEvent>(OnAttacked);
    }

    private void OnAttacked(Entity<StatusEffectContainerComponent> ent, ref AttackedEvent args)
    {
        if (!_status.TryEffectsWithComp<MeleeVulnerabilityStatusEffectComponent>(ent, out var effects))
            return;

        foreach (var effect in effects)
        {
            if (effect.Comp1.ApplyToArmedAttacks && args.User != args.Used
                || effect.Comp1.ApplyToUnarmedAttacks && args.User == args.Used)
                args.ModifiersList.AddRange(effect.Comp1.ModifierSets);
        }
    }
}
